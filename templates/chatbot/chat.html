{% extends 'base.html' %}
{% load static %}

{% block title %}AI Assistant | Smart Tourism India{% endblock %}

{% block content %}
<section class="section-padding">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="chat-container">
          <div class="chat-header">
            <i class="fas fa-robot"></i>
            <h5 class="mb-0 ms-2">AI Tourism Assistant</h5>
            <span class="ms-auto text-light-50">Ask about destinations, culture, food, or travel tips</span>
          </div>
          <div id="chatMessages" class="chat-messages">
            <!-- Messages will be appended here -->
          </div>
          <div class="chat-input">
            <input id="chatInput" type="text" class="form-control" placeholder="Type your message..." />
            <button id="voiceBtn" class="voice-btn" title="Voice input" data-bs-toggle="tooltip" data-bs-placement="top">
              <i class="fas fa-microphone"></i>
            </button>
            <button id="sendBtn" class="btn btn-primary">
              <i class="fas fa-paper-plane me-1"></i> Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  let sessionId = null;
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const voiceBtn = document.getElementById('voiceBtn');

  function appendMessage(type, text) {
    const wrapper = document.createElement('div');
    wrapper.className = `message ${type}`;

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = text.replace(/\n/g, '<br>');

    wrapper.appendChild(avatar);
    wrapper.appendChild(bubble);
    chatMessages.appendChild(wrapper);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendMessage(message, inputType='text') {
    if (!message.trim()) return;

    appendMessage('user', message);
    chatInput.value = '';

    const loading = document.createElement('div');
    loading.className = 'message bot';
    loading.innerHTML = '<div class="message-avatar"><i class="fas fa-robot"></i></div><div class="message-bubble"><div class="loading-spinner"></div> Thinking...</div>';
    chatMessages.appendChild(loading);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      const res = await fetch('{% url "chatbot:send_message" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({ message, session_id: sessionId, input_type: inputType })
      });

      const data = await res.json();
      chatMessages.removeChild(loading);

      if (data.success) {
        sessionId = data.session_id;
        appendMessage('bot', data.response);
      } else {
        appendMessage('bot', 'Sorry, I could not process that.');
      }
    } catch (e) {
      chatMessages.removeChild(loading);
      appendMessage('bot', 'Network error. Please try again.');
    }
  }

  sendBtn.addEventListener('click', () => sendMessage(chatInput.value));
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage(chatInput.value);
  });

  // Web Speech API integration
  let recognition = null;
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-IN';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.addEventListener('result', (event) => {
      const transcript = event.results[0][0].transcript;
      chatInput.value = transcript;
      sendMessage(transcript, 'voice');
    });

    recognition.addEventListener('start', () => {
      voiceBtn.classList.add('recording');
      voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
    });

    recognition.addEventListener('end', () => {
      voiceBtn.classList.remove('recording');
      voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
    });

    voiceBtn.addEventListener('click', () => {
      try {
        recognition.start();
      } catch (e) {
        // Ignore if already started
      }
    });
  } else {
    voiceBtn.disabled = true;
    voiceBtn.title = 'Voice input not supported in this browser';
  }
</script>
{% endblock %}
