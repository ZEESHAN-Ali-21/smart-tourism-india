{% extends 'base.html' %}
{% load static %}
{% load destination_extras %}

{% block title %}Smart Tourism India - Discover Incredible India{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center min-vh-100">
            <div class="col-lg-8">
                <div class="hero-content">
                    <h1 class="hero-title">
                        Discover <span class="text-gradient">Incredible India</span>
                    </h1>
                    <p class="hero-subtitle">
                        Explore India's rich heritage, diverse cultures, and breathtaking destinations with our smart tourism platform
                    </p>
                    <div class="hero-actions">
                        <a href="{% url 'tourism:destinations' %}" class="btn btn-primary btn-lg me-3">
                            <i class="fas fa-compass me-2"></i>
                            Explore Destinations
                        </a>
                        <a href="{% url 'tourism:interactive_maps' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-globe me-2"></i>
                            Interactive Maps
                        </a>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="stats-grid">
                    <div class="stat-item">
                        <h3 class="stat-number">{{ total_destinations }}+</h3>
                        <p class="stat-label">Destinations</p>
                    </div>
                    <div class="stat-item">
                        <h3 class="stat-number">{{ total_states }}+</h3>
                        <p class="stat-label">States Covered</p>
                    </div>
                    <div class="stat-item">
                        <h3 class="stat-number">8</h3>
                        <p class="stat-label">Categories</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Search Section -->
<section class="py-5" style="background: var(--light-color);">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="search-container">
                    <form method="GET" action="{% url 'tourism:search' %}" id="searchForm" class="position-relative">
                        <input type="text" name="q" class="search-bar" placeholder="Search destinations, cities, states..." id="searchInput" autocomplete="off">
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i>
                        </button>
                        <!-- Search Results Dropdown -->
                        <div id="searchResults" class="search-results-dropdown" style="display: none;">
                            <div class="search-results-loading">
                                <i class="fas fa-spinner fa-spin"></i> Searching...
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Featured Destinations -->
<section class="section-padding section-nature">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="section-title" style="color: var(--secondary-color);">Featured Destinations</h2>
            <p class="section-subtitle">Discover India's most iconic and breathtaking places</p>
        </div>
        
        <div class="row">
            {% for destination in featured_destinations %}
                {% destination_card destination show_description=True card_class="fade-in" %}
            {% empty %}
            <div class="col-12 text-center">
                <p class="text-muted">No featured destinations available at the moment.</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Show More Featured Button -->
        <div class="text-center mt-4">
            <a href="{% url 'tourism:destinations' %}?featured=1" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-star me-2"></i>
                View All Featured Destinations
            </a>
        </div>
    </div>
</section>

<!-- Categories Section -->
<section class="section-padding section-transparent">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="section-title section-title-transparent">Explore by Category</h2>
            <p class="section-subtitle section-subtitle-transparent">Find destinations that match your interests</p>
        </div>
        
        <div class="row">
            {% for category in categories %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                <a href="{% url 'tourism:destinations_by_category' category.name %}" class="text-decoration-none">
                    <div class="card category-card h-100 text-center">
                        <div class="card-body">
                            <i class="{{ category.icon }} fa-3x text-primary mb-3"></i>
                            <h5 class="card-title">{{ category.get_name_display }}</h5>
                            <p class="card-text text-muted">{{ category.destination_count }} destinations</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Map Section -->
<section class="section-padding section-sunset">
    <div class="container">
        <div class="text-center mb-5">
            <h2 class="section-title" style="color: var(--accent-orange);">Explore India Map</h2>
            <p class="section-subtitle">Interactive map showing all destinations</p>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div id="map" style="height: 500px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Call to Action -->
<section class="bg-gradient text-white py-5">
    <div class="container text-center">
        <h2 class="mb-3">Ready to Explore India?</h2>
        <p class="lead mb-4">Get personalized recommendations from our AI assistant</p>
        <a href="{% url 'chatbot:chat' %}" class="btn btn-light btn-lg">
            <i class="fas fa-robot me-2"></i>
            Start Chatting
        </a>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Mapbox GL JS map if element exists
    if (document.getElementById('map')) {
        // Initialize Mapbox map with 3D features
        const map = mapboxUtils.initMap('map', {
            center: [78.9629, 20.5937], // Center of India [lng, lat]
            zoom: 4.5,
            pitch: 45, // 3D angle
            bearing: 0
        });
        
        // Prepare destinations data for map
        const destinations = [
            {% for destination in featured_destinations %}
            {% if destination.latitude and destination.longitude %}
            {
                name: "{{ destination.name|escapejs }}",
                latitude: {{ destination.latitude }},
                longitude: {{ destination.longitude }},
                city: "{{ destination.city|escapejs }}",
                state: {name: "{{ destination.state.name|escapejs }}"},
                short_description: "{{ destination.short_description|escapejs }}",
                description: "{{ destination.description|escapejs }}",
                average_rating: {{ destination.average_rating|default:0 }},
                slug: "{{ destination.slug }}",
                categories: [{% for cat in destination.categories.all %}{name: "{{ cat.name }}"}{% if not forloop.last %},{% endif %}{% endfor %}]
            }{% if not forloop.last %},{% endif %}
            {% endif %}
            {% endfor %}
        ];
        
        // Show destinations on map with 3D markers
        if (destinations.length > 0) {
            mapboxUtils.showDestinations(destinations);
        }
    }
    
    console.log('Home page loaded successfully');
    
    // Initialize search functionality
    initializeSearch();
});

// Search functionality
let searchTimeout;
let currentSearchResults = [];

function initializeSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const searchForm = document.getElementById('searchForm');
    
    if (!searchInput || !searchResults) return;
    
    // Search on input with debounce
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (query.length < 2) {
            hideSearchResults();
            return;
        }
        
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    // Handle form submission
    searchForm.addEventListener('submit', function(e) {
        const query = searchInput.value.trim();
        if (!query) {
            e.preventDefault();
            return;
        }
        // Allow form to submit normally to Django search view
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchForm.contains(e.target)) {
            hideSearchResults();
        }
    });
}

function performSearch(query) {
    const searchResults = document.getElementById('searchResults');
    if (!searchResults) return;
    
    showSearchLoading();
    
    // Search in destinations first (local data)
    const destinations = [
        {% if featured_destinations %}
        {% for destination in featured_destinations %}
        {% if destination.name and destination.city and destination.state %}
        {
            name: "{{ destination.name|escapejs }}",
            city: "{{ destination.city|escapejs }}",
            state: "{{ destination.state.name|escapejs }}",
            slug: "{{ destination.slug|escapejs }}",
            rating: {{ destination.average_rating|default:0 }},
            type: 'destination'
        }{% if not forloop.last %},{% endif %}
        {% endif %}
        {% endfor %}
        {% endif %}
    ];
    
    // Filter local destinations
    const localResults = destinations.filter(dest => 
        dest && dest.name && (
            dest.name.toLowerCase().includes(query.toLowerCase()) ||
            (dest.city && dest.city.toLowerCase().includes(query.toLowerCase())) ||
            (dest.state && dest.state.toLowerCase().includes(query.toLowerCase()))
        )
    ).slice(0, 5);
    
    // Search using Mapbox Geocoding API if available
    if (window.MAPBOX_CONFIG && window.MAPBOX_CONFIG.accessToken) {
        fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?country=IN&limit=3&access_token=${mapboxgl.accessToken}`)
            .then(response => response.json())
            .then(data => {
                const mapboxResults = data.features ? data.features.map(feature => ({
                    name: feature.place_name,
                    latitude: feature.center[1],
                    longitude: feature.center[0],
                    city: feature.context ? feature.context.find(c => c.id.includes('place'))?.text : '',
                    state: feature.context ? feature.context.find(c => c.id.includes('region'))?.text : '',
                    country: 'India',
                    type: 'location'
                })) : [];
                
                const combinedResults = [...localResults, ...mapboxResults.slice(0, 3)];
                displaySearchResults(combinedResults, query);
            })
            .catch(() => {
                displaySearchResults(localResults, query);
            });
    } else {
        displaySearchResults(localResults, query);
    }
}

function showSearchLoading() {
    const searchResults = document.getElementById('searchResults');
    if (!searchResults) return;
    
    searchResults.innerHTML = `
        <div class="search-results-loading">
            <i class="fas fa-spinner fa-spin"></i> Searching...
        </div>
    `;
    searchResults.style.display = 'block';
}

function displaySearchResults(results, query) {
    const searchResults = document.getElementById('searchResults');
    if (!searchResults) return;
    
    currentSearchResults = results;
    
    if (results.length === 0) {
        searchResults.innerHTML = `
            <div class="search-no-results">
                <i class="fas fa-search mb-2"></i>
                <p class="mb-2">No results found for "${query}"</p>
                <div class="search-suggestions">
                    <span class="search-suggestion" onclick="searchSuggestion('Taj Mahal')">Taj Mahal</span>
                    <span class="search-suggestion" onclick="searchSuggestion('Kerala')">Kerala</span>
                    <span class="search-suggestion" onclick="searchSuggestion('Goa')">Goa</span>
                    <span class="search-suggestion" onclick="searchSuggestion('Rajasthan')">Rajasthan</span>
                </div>
            </div>
        `;
    } else {
        let html = '';
        results.forEach((result, index) => {
            const icon = result.type === 'destination' ? 'fas fa-mountain' : 'fas fa-map-marker-alt';
            const subtitle = result.city && result.state ? `${result.city}, ${result.state}` : 
                            result.state ? result.state : 
                            result.country ? result.country : 'Location';
            
            html += `
                <div class="search-result-item" onclick="selectSearchResult(${index})">
                    <div class="search-result-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div class="search-result-content">
                        <div class="search-result-title">${result.name}</div>
                        <p class="search-result-subtitle">${subtitle}</p>
                        ${result.rating ? `<small class="text-warning">‚≠ê ${result.rating.toFixed(1)}</small>` : ''}
                    </div>
                </div>
            `;
        });
        searchResults.innerHTML = html;
    }
    
    searchResults.style.display = 'block';
}

function selectSearchResult(index) {
    const result = currentSearchResults[index];
    if (!result) return;
    
    if (result.type === 'destination' && result.slug) {
        // Navigate to destination detail page
        window.location.href = `/destinations/${result.slug}/`;
    } else if (result.latitude && result.longitude) {
        // Update search input and focus on map
        document.getElementById('searchInput').value = result.name;
        hideSearchResults();
        
        // Focus on location on map if available
        if (mapboxUtils && mapboxUtils.map) {
            mapboxUtils.focusOnDestination({
                name: result.name,
                latitude: result.latitude,
                longitude: result.longitude,
                city: result.city,
                state: result.state
            });
            
            // Add a temporary marker
            const tempMarker = mapboxUtils.addMarker({
                name: result.name,
                latitude: result.latitude,
                longitude: result.longitude,
                city: result.city || '',
                state: {name: result.state || ''},
                short_description: `Search result for ${result.name}`,
                average_rating: result.rating || 0,
                slug: result.slug || '#'
            });
        }
    } else {
        // Fallback: search on the site
        document.getElementById('searchInput').value = result.name;
        document.getElementById('searchForm').submit();
    }
}

function searchSuggestion(suggestion) {
    document.getElementById('searchInput').value = suggestion;
    performSearch(suggestion);
}

function hideSearchResults() {
    const searchResults = document.getElementById('searchResults');
    if (searchResults) {
        searchResults.style.display = 'none';
    }
    currentSearchResults = [];
}
</script>
{% endblock %}
